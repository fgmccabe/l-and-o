lo.comp.manifest{
  import lo.
  import lo.resources.
  import lo.uri.
  import lo.comp.package.
  import lo.comp.parseutils.

  public type manifest ::= manifest(list[manifestEntry]).

  -- A manifest entry looks like:
  -- packageName : { (version:file[uri])* }

  type manifestEntry ::= manifestEntry(string,list[(version,uri,string)]).

  -- Tokenization and parsing manifest files

  private type token ::= mAnifest | lbrce | rbrce | eqUals | stAr 
    | pkgId(string) | utok(list[integer]).

  tokens:(list[token]) --> list[integer].
  tokens(Toks) --> spaces(), moreToks(Toks).

  moreToks:(list[token]) --> list[integer].
  moreToks([]) --> eof.
  moreToks([Tok,..More]) --> token(Tok), tokens(More).

  token:(token) --> list[integer].
  token(mAnifest) --> "manifest".
  token(lbrce) --> "{".
  token(rbrce) --> "}".
  token(start) --> "*".
  token(colon) --> ":".
  token(eqUals) --> "=".
  token(utok(Seq)) --> "[", stringText(Seq), "]".
  token(pkgId(Nm)) --> pkgIden(Nm).

  stringText:(list[integer]) --> list[integer].
  stringText([]) --> [].
  stringText([C,..More]) --> "\\", quote(C), stringText(More).
  stringText([C,..More]) --> [C], { C \= 0c] }, stringText(More).

  quote:(integer) --> list[integer].
  quote(0c\n) --> "n".
  quote(0c") --> "\"".
  quote(0c') --> "'".
  quote(0c\t) --> "t".
  quote(C) --> [C].

  public readManifest:(uri) => manifest.
  readManifest(u) => m :- parseManifest(m) %% getResource(u).

  public flushManifest:(uri,manifest){}.
  flushManifest(Root,M) :-
    putResource(Root,flatten(disp(M))).

  -- Parsing a manifest from tokens
  public parseManifest:(manifest) --> list[integer].
  parseManifest(M) --> tokens(TL), { pManifest(M) %% TL}.

  pManifest:(manifest) --> list[token].
  pManifest(manifest(E)) --> [mAnifest, lbrce], entries(E), [rbrce].

  entries:(list[manifestEntry]) --> list[token].
  entries([Entry,..More]) --> entry(Entry), entries(More).
  entries([]) --> [].

  entry:(manifestEntry) --> list[token].
  entry(manifestEntry(Pk,Versions)) --> [pkgId(Pk), colon, lbrce], versions(Versions), [rbrce].

  versions:(list[(version,uri,string)]) --> list[token].
  versions([V,..More]) --> version(V), versions(More).
  versions([]) --> [].

  version:((version,uri,string)) --> list[token].
  version((V,Uri,Fn)) --> versionName(V), [equals, pkgId(Fn), utok(U)], { uriParse(Uri)%%U }.

  versionName:(version) --> list[token].
  versionName(defltVersion) --> [stAr].
  versionName(vers(S)) --> [pkgId(S)].

  -- Displaying a manifest
  public implementation display[manifest] .. {
    disp(manifest(E)) => ssSeq([ss("manifest"),ss("{\n"),ssSeq(showEntries(E)),ss("}\n")]).
  }

  showEntries:(list[manifestEntry]) => list[ss].
  showEntries([]) => [].
  showEntries([E,..L]) => [showEntry(E),..showEntries(L)].

  showEntry:(manifestEntry) => ss.
  showEntry(manifestEntry(Pk,Versions)) => ssSeq([ss("  "),ss(Pk),ss(":{\n"),ssSeq(showVersions(Versions)),ss("  }\n")]).

  showVersions:(list[(version,uri,string)]) => list[ss].
  showVersions([]) => [].
  showVersions([V,..M]) => [showVersion(V),..showVersions(M)].

  showVersion:((version,uri,string)) => ss.
  showVersion((V,SrcUri,CodeFn)) => ssSeq([ss("    "),disp(V),ss("="),ss(CodeFn),ss("["),disp(SrcUri),ss("]\n")]).

  -- Simple API to manipulate entries in a mAnifest

  public locateVersion:(manifest,string,version,version,uri,string){}.
  locateVersion(manifest(Entries),Pkg,Vers,Act,SrcUri,CodeFn) :-
    manifestEntry(Pkg,V) in Entries,
    getVersion(Vers,Act,V,SrcUri,CodeFn).

  getVersion:(version,version,list[(version,uri,string)],uri,string){}.
  getVersion(Vers,Vers,V,SrcUri,CodeFn) :- (Vers,SrcUri,CodeFn) in V!.
  getVersion(defltVersion,Act,V,SrcUri,CodeFn) :- (Act,SrcUri,CodeFn) in V!.

  public addToManifest:(manifest,uri,string,version,string) => manifest.
  addToManifest(manifest(M),SrcUri,Pkg,Version,CodeFn) => manifest(addEntry(M,SrcUri,Pkg,Version,CodeFn)).

  addEntry:(list[manifestEntry],uri,string,version,string) => list[manifestEntry].
  addEntry([],SrcUri,Pkg,Version,CodeFn) => [(manifestEntry(Pkg,[(Version,SrcUri,CodeFn)]))].
  addEntry([manifestEntry(Pkg,Vers),..E],SrcUri,Pkg,Version,CodeFn) => [manifestEntry(Pkg,addVersion(Vers,SrcUri,Version,CodeFn)),..E].
  addEntry([E,..M],SrcUri,Pkg,Version,CodeFn) => [E,..addEntry(M,SrcUri,Pkg,Version,CodeFn)].

  addVersion:(list[(version,uri,string)],uri,version,string) => list[(version,uri,string)].
  addVersion([],SrcUri,Vers,CodeFn) => [(Vers,SrcUri,CodeFn)].
  addVersion([(Vers,_,_),..V],SrcUri,Vers,CodeFn) => [(Vers,SrcUri,CodeFn),..V] . -- replace version
  addVersion([V,..M],SrcUri,Vers,CodeFn) => [V,..addVersion(M,SrcUri,Vers,CodeFn)].
}